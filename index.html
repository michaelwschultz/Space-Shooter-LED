<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/tachyons/css/tachyons.min.css">
<style>
    .wrapper {
        display: flex;
        flex-direction: column;
        /*height: 100vh;*/
        align-items: center;
        justify-content: space-between;
    }
    .hidden {
        visibility: hidden;
    }
</style>

<body class="sans-serif pa2 bg-navy" style="height: 100%;">

    <div class="wrapper">
        <div>
            <h1 class="lightest-blue">LED Board Simulator</h1>
            <div id="board-lights" class="absolute"></div>
            <div id="board"></div>
        </div>

        <!-- <audio id="musicPlayer" autoplay loop>
            <source src="parallaxing_atmosphere.mp3" type="audio/mpeg">
        </audio> -->
    </div>

    <script>

        //** Variables and setup **//
        // generate an alphabet
        let alphabet = "abcdefghijklmnopqrstuvwxyz".split('');
        let shipLocation = {row: null, column: null};
        let shipColor = "";
        let fps = 30;
        let frame = 0;

        const ledColor = "bg-dark-blue";

        // document.getElementById("musicPlayer").volume = 0.5;

        // keyboard controls
        document.onkeydown = function(e) {
            switch (e.keyCode) {
                case 32:
                    bullet(shipLocation, "bg-red", 30);
                    break;
                case 38: // up
                    moveShipUp();
                    break;
                case 87: // w
                    moveShipUp();
                    break;
                case 40: // down
                    moveShipDown();
                    break;
                case 83: // s
                    moveShipDown();
                    break;
            }
        };




        //** LED Board **//

        // Build 16 rows with 32 divs
        function getBoard(boardName, ledName, defaultColor = "") {
            for (r = 0; r < 16; r++) { 
                let currentRow = 'row-' + alphabet[r];
                document.getElementById(boardName).innerHTML += "<div id='row-" + alphabet[r] + "'></div>";
                

                for (c = 0; c < 32; c++) {
                    document.getElementById(currentRow).innerHTML += "<div id='" + alphabet[r] + c + "-" + ledName + "' class='dib pa1 ma1 br-100 " + defaultColor + "'></div>";
                }
            }
        }

        // Turn on a single light
        function turnOn(location, color) {
            document.getElementById(location.row + location.column + "-light").classList.add(color);
            document.getElementById(location.row + location.column + "-light").classList.remove("hidden");
        }

        // Turn off a single light
        function turnOff(location) {
            document.getElementById(location.row + location.column + "-light").classList.add("hidden");
        }

        // Turn on all the lights
        function lightsOn(color) {
            console.log("lights on");

            for (r = 0; r < 16; r++) {
                for (c = 0; c < 32; c++) {document.getElementById(alphabet[r] + c).classList.add(color);
                    document.getElementById(alphabet[r] + c).classList.remove(ledColor);
                }
            }
        };

        // Turn all the lights off
        function lightsOff() {
            console.log("lights off");

            for (r = 0; r < 16; r++) {
                for (c = 0; c < 32; c++) {
                    document.getElementById(alphabet[r] + c).classList.add(ledColor);
                    document.getElementById(alphabet[r] + c).classList.remove(color);
                }
            }
        }

        // Turn a light on then back off
        function blink(led, color, duration, delay) {
            setTimeout(function() {
                turnOn(null, led, color);
                document.getElementById(led).classList.add(color);
                document.getElementById(led).classList.remove(ledColor);

                setTimeout(function() {
                    document.getElementById(led).classList.add(ledColor);
                    document.getElementById(led).classList.remove(color);
                }, duration);
            }, delay);
        }

        // Bullet shot light effect
        function bullet(shipLocation, color, speed) {
            console.log("shot fired");

            let shotDelay = speed * 1.04;

            for (i = 1; i < 32; i++) {
                setTimeout(function(led) {
                    let bulletLocation = new Location(shipLocation.row, led);
                    
                    return function() {
                        turnOn(bulletLocation, color);
                    };
                }(i), speed*i);

                setTimeout(function(led) {
                    let removeBulletLocation = new Location(shipLocation.row, led);

                    return function() {
                        turnOff(removeBulletLocation);
                    };
                }(i), shotDelay * i);
            }
        }




        //** Ship creation and movement **//

        function placeShip(location, color) {
            console.log("Ship hovering at row " + location);
            shipLocation = location;
            shipColor = color;

            turnOn(location, shipColor);
        }

        function moveShipUp() {
            let shipRow = alphabet.indexOf(shipLocation.row);

            if (shipRow > 0) {
                turnOff(shipLocation);
                    shipRow = shipRow - 1;
                    shipLocation.row = alphabet[shipRow];
                turnOn(shipLocation, shipColor);
            }
        }

        function moveShipDown() {
            let shipRow = alphabet.indexOf(shipLocation.row);

            if (shipRow < 15) {
                turnOff(shipLocation);
                    shipRow = shipRow + 1;
                    shipLocation.row = alphabet[shipRow];
                turnOn(shipLocation, shipColor);
            }
        }


        function render() {
            // console.log(frame);

            // 1) Create an array of game objects, which define their position and color
            // for loop through all objects...
            // turn on leds accordingly.. if there is nothing in that space turn the led off

            turnOn(new Location("b", 24), "bg-red");

            // turn on light based on fps between 1 (every frame) and 30 (once every 30 frames or once a second)
            if (frame % 1 === 0) {
                turnOn(new Location("d", 15), "bg-yellow");
            } else {
                turnOff(new Location("d", 15));
            }
            frame++;
        }



        //** Instructions **//

        getBoard("board", "slot", "bg-dark-blue");
        getBoard("board-lights", "light");


        // turnOn("a15", "bg-green");


        class Location {
            constructor(row, column) {
                this.row = row;
                this.column = column;
            }
        };

        placeShip(new Location("i", 0), "bg-yellow");


        // setInterval(render, fps);



        // do while: this need to happen 30fps
        // while (true) {
        //    setTimeout(function() {
        //         draw(frame);
        //         frame++;
        //     }, 1000 / fps);
        // }


        //** Test commands **//

        // turnOn(new Location("b", 24), "bg-red");

        // turnOn(4, 15, "bg-green");
        // turnOff(4, 15);

        // lightsOn("bg-yellow");
        // setTimeout(function() { lightsOff() }, 3000);

        // blink("i15", "bg-red", 500, 1000);
        // blink("i16", "bg-yellow", 500, 1500);
        // blink("i17", "bg-green", 500, 2000);

    </script>

</body>